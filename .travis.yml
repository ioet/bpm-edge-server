sudo: required
language: java
env:
  - APP_NAME=bpm-edge-server
  - AWS_ECR_ACCOUNT=524819651720
jdk:
 - oraclejdk8
services:
 - docker
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
after_success:
 - docker --version
 - pip install --user awscli # install aws cli w/o sudo  - export PATH=$PATH:$HOME/.local/bin # put aws in the path
 - eval $(aws ecr get-login --no-include-email --region us-east-1) #needs AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY envvars
 - docker build -t $APP_NAME:$TRAVIS_BUILD_ID . --build-arg JAR_FILE=build/libs/edge-server-1.0.jar
 - docker tag $APP_NAME:$TRAVIS_BUILD_ID $AWS_ECR_ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/$APP_NAME:$TRAVIS_BUILD_ID
 - docker push $AWS_ECR_ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/$APP_NAME:$TRAVIS_BUILD_ID
 - docker tag $APP_NAME:latest $AWS_ECR_ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/$APP_NAME:latest
 - docker push $AWS_ECR_ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/$APP_NAME:latest
 
